/*
  video h5 player
  Telegram yhcms520
*/
var player={wap:navigator.userAgent.match(/iPhone|Android|Linux|iPod/i)!=null,wxqq:navigator.userAgent.indexOf("MicroMessenger")>-1||(navigator.userAgent.indexOf("QQ")>-1&&navigator.userAgent.indexOf("_SQ_")>-1),width:"100%",height:"100%",type:"app",ads:{time:0,pic:"",url:""},pay:{init:0,time:0,nums:0,msg:"试看已结束，成为VIP后可观看完整视频哟~",btntxt:"立即升级"},form:"auto",socket:null,video:null,progress:null,duration:0,currentTime:0,time:0,nexturl:"",tindex:null,full:false,callback:null,cmd:false,voddata:{name:"",xid:1,jid:0,vid:0,zid:0,},init:function(f){if(!f.id){return}if(f.type){player.type=f.type}if(f.width){player.width=f.width}if(f.height){player.height=f.height}if(f.pay.init){player.pay.init=f.pay.init}if(f.pay.time){player.pay.time=f.pay.time}if(f.pay.nums){player.pay.nums=f.pay.nums}if(f.pay.msg){player.pay.msg=f.pay.msg}if(f.pay.btntxt){player.pay.btntxt=f.pay.btntxt}if(f.pay.btnurl){player.pay.btnurl=f.pay.btnurl}if(f.form){player.form=f.form}if(f.ads){player.ads=f.ads}if(f.callback){player.callback=f.callback}if(f.voddata){player.voddata=f.voddata}if(f.nexturl){player.nexturl=f.nexturl}if(player.wap&&!player.wxqq){player.pay.nums=-1;player.pay.time=0}var e=player.nexturl?'<div class="next"></div>':"";if(player.type=="app"){if(!player.wap){var d='<div oncontextmenu="return false" style="width:'+player.width+";height:"+player.height+'" id="video-hls-box">'+(player.ads.pic?'<div class="video-hls-ads"><div class="video-hls-ads-box"><a target="_blank" href="'+player.ads.url+'"><img src="'+player.ads.pic+'"><div class="adtime">广告倒计时'+player.ads.time+'s</div><div class="adsbtn">查看详情</div></a><div class="adsvip">跳过</div></div></div>':"")+'<div class="video-box"><div id="canvasBarrage"></div><video id="hlsvideo" src="" webkit-playsinline="true" playsinline="true" autoplay=""></video></div><div class="load" style="display: none;"></div><div class="play" style="display: none;"></div><div class="pay-box" style="display: none;"><div class="pay-tps">'+player.pay.msg+'</div><div class="pay-btn">'+player.pay.btntxt+'</div></div><div class="video-hls-cmd"><div class="video-tip-proved"></div><div class="video-hls-slide"><div class="progress"><div class="buffer"></div><div class="percent"></div></div></div><div class="video-hls-bottom"><div class="play"></div>'+e+'<div class="time"><span class="currentTime">00:00</span> / <span class="duration">00:00</span></div><div class="video-right"><div class="video-barrage"><span class="video-barrage-off on"></span><input class="video-barrage-val" type="text" id="video-barrage-val" placeholder="弹幕走一波..."><span class="video-barrage-btn"><i></i></span></div><div class="multiple">倍速<ul><li data-val="2.0">2.0X</li><li data-val="1.5">1.5X</li><li data-val="1.25">1.25X</li><li class="on" data-val="1.0">1.0X</li><li data-val="0.75">0.75X</li></ul></div><div class="voice"><div class="voice-box"><div id="voice-box1"><div id="voice-box2"></div><div id="voice-box3"></div></div></div></div><div class="full"></div></div></div></div><div class="video-play-btn"></div><div class="video-pause-btn"></div><div class="video-tips"></div></div></div>'}else{var d='<div oncontextmenu="return false" style="width:'+player.width+";height:"+player.height+'" id="video-hls-box">'+(player.ads.pic?'<div class="video-hls-ads"><div class="video-hls-ads-box"><a target="_blank" href="'+player.ads.url+'"><img src="'+player.ads.pic+'"><div class="adtime">广告倒计时'+player.ads.time+'s</div><div class="adsbtn">查看详情</div></a><div class="adsvip">跳过</div></div></div>':"")+'<div class="video-box"><div id="canvasBarrage"></div><video style="display:none;" id="hlsvideo" src="" controls="controls" webkit-playsinline playsinline x-webkit-airplay="disallow" airplay="disallow" x5-video-player-type="h5" x5-video-player-fullscreen="true" x5-video-orientation="landscape|portrait"></video></div><div class="pay-box" style="display: none;"><div class="pay-tps">'+player.pay.msg+'</div><div class="pay-btn">'+player.pay.btntxt+'</div></div><div class="video-hls-cmd"><div class="video-tip-proved"></div></div></div></div>'}}else{var d='<div oncontextmenu="return false" style="width:'+player.width+";height:"+player.height+'" id="video-hls-box">'+(player.ads.pic?'<div class="video-hls-ads"><div class="video-hls-ads-box"><a target="_blank" href="'+player.ads.url+'"><img src="'+player.ads.pic+'"><div class="adtime">广告倒计时'+player.ads.time+'s</div><div class="adsbtn">查看详情</div></a><div class="adsvip">跳过</div></div></div>':"")+"</div>"}$("#"+f.id).html(d);setTimeout(function(){player.video=document.getElementById("hlsvideo");if(f.url!=""){if(player.ads.time&&player.ads.pic&&player.ads.url){$(".video-hls-ads").show();player.get_ads(f.url)}else{player.load(f.url)}}if(player.nexturl==""){$(".video-hls-bottom .next").hide()}},1000);$("#video-hls-box .pay-btn,.video-tip-proved").click(function(){if(player.callback){player.callback({code:"pay"})}});$("body").on("click",".video-hls-ads .adsvip",function(){if(player.callback){player.callback({code:"ads"})}})},load:function(h){if(player.pay.init==5||(player.pay.init>0&&player.pay.nums<0)){player.video.src="";$(".pay-box").show();$(".video-hls-cmd,.video-box,.load").remove();$(".video-box").empty();return}if(player.type=="web"){return player.get_link(h)}if(!player.video){return}if(player.pay.init>0){if(player.pay.time>0){if(player.pay.init==4){var g='试看 <font style="color:#f60">'+player.pay.time+"秒</font>，您的金币不足，观看完整视频请 <font color=#bf8f4d>充值</font>"}else{if(player.pay.init==3){var g='试看 <font style="color:#f60">'+player.pay.time+"秒</font>，观看完整视频请 <font color=#bf8f4d>购买</font>"}else{if(player.pay.init==2){var g='试看 <font style="color:#f60">'+player.pay.time+"秒</font>，观看完整视频请 <font color=#bf8f4d>开通VIP</font>"}else{var g='试看 <font style="color:#f60">'+player.pay.time+"秒</font>，观看完整视频 <font color=#bf8f4d>请登录</font>"}}}}else{if(player.pay.init>2){var g='今日试看剩余 <font style="color:#f60">'+player.pay.nums+"部</font>，<font color=#bf8f4d>购买</font> 后可无限观看"}else{if(player.pay.init==2){var g='今日试看剩余 <font style="color:#f60">'+player.pay.nums+"部</font>，<font color=#bf8f4d>开通VIP</font> 后可无限观看"}else{var g='今日试看剩余 <font style="color:#f60">'+player.pay.nums+"部</font>，<font color=#bf8f4d>登录</font> 后可增加观看次数"}}}$(".video-tip-proved").html(g).show()}if(player.wap){player.video.src=h;$("#hlsvideo").show()}else{$("#video-hls-box .load").show();if(player.form=="m3u8"||h.indexOf(".m3u8")>-1){if(Hls.isSupported()){var e=new Hls();e.loadSource(h);e.attachMedia(player.video)}}else{player.video.src=h}}player.video.addEventListener("canplay",function(a){player.play();$(".video-hls-bottom .play").addClass("on");player.tindex=setTimeout(function(){player.get_cmd_hide()},3000)});player.video.addEventListener("timeupdate",function(){player.timeupdate(player.video.currentTime,player.video.duration)});player.video.onended=function(){if(player.nexturl){window.location.href=player.nexturl}};document.onkeydown=function(b){var c=b||window.event||arguments.callee.caller.arguments[0];if(c){if(c.keyCode==37){player.video.currentTime!==0?player.video.currentTime-=5:1;var a=player.video.currentTime/player.video.duration*100;$(".video-hls-bottom .time .currentTime").html(_0x2f2e4c(player.video.currentTime));$(".video-hls-slide .percent").css("width",a+"%");return false}if(c.keyCode==39){player.video.currentTime!==player.video.duration?player.video.currentTime+=5:1;var a=player.video.currentTime/player.video.duration*100;$(".video-hls-bottom .time .currentTime").html(_0x2f2e4c(player.video.currentTime));$(".video-hls-slide .percent").css("width",a+"%");return false}if(c.keyCode==32){player.play();return false}}};if(!player.wap){player.video.addEventListener("waiting",function(){player.waiting()});player.get_duration();player.get_percent();$(".video-hls-bottom .play,.video-box").click(function(){player.play()});$(".video-hls-bottom .next").click(function(){if(player.nexturl){window.location.href=player.nexturl}});$("#video-hls-box .video-hls-cmd").hover(function(){player.cmd=true},function(){player.cmd=false});$("#video-hls-box .voice,#video-hls-box .multiple,#video-hls-box .video-hls-slide").hover(function(){$(this).addClass("on")},function(){$(this).removeClass("on")});$("#video-hls-box .multiple ul li").click(function(){player.video.playbackRate=$(this).data("val");$("#video-hls-box .multiple ul li").removeClass("on");$(this).addClass("on")});$("#video-hls-box .multiple ul li").hover(function(){$(this).animate({fontSize:"14px"},20)},function(){$(this).animate({fontSize:"12px"},20)});$(".video-hls-bottom .full").click(function(){if(!player.full){player.FullScreen()}else{player.exitFullscreen()}});$(".video-hls-bottom .full").hover(function(){var a=$("#video-hls-box").width()-42;$("#video-hls-box .video-tips").html(player.full?"退出全屏":"全屏").css("left",a+"px").show()},function(){$("#video-hls-box .video-tips").hide()});document.addEventListener("webkitfullscreenchange",function(){if(player.full){player.exitFullscreen()}});var f=sby=jdt=0;$("#video-hls-box").mousemove(function(a){if((f!=a.pageX||sby!=a.pageY)&&jdt==0){if(player.tindex){clearTimeout(player.tindex)}jdt=1;$(".video-hls-cmd").animate({bottom:"0px"},500);player.tindex=setTimeout(function(){jdt=0;player.get_cmd_hide();clearTimeout(player.tindex)},3000)}f=a.pageX;sby=a.pageY});player.get_volume("voice-box3","voice-box2","voice-box1");player.get_barrage()}else{$("#canvasBarrage,.video-barrage,.video-hls-cmd").hide()}},get_barrage:function(){var b=md5(player.voddata.name+player.voddata.xid);player.socket=io("https://api.barrage.yhcms.cc");player.socket.on("connect",function(){player.socket.emit("login",b)});player.socket.on("new_msg",function(a){a=JSON.parse(a);player.get_barrage_send(a)});player.socket.on("update_online_count",function(a){console.log(a)});$.getJSON("//api.yhcms.cc/barrage",{name:player.voddata.name,jid:player.voddata.xid},function(a){if(a.code==1){player.barrage=a.data.list}},"json");$("body").on("click","#canvasBarrage .barrage-span",function(){var a=$(this).attr("data-url");if(a!=undefined){window.open(a,"_blank")}});$("body").on("click",".video-barrage-btn",function(){if(!$(".video-barrage-off").hasClass("on")){return}var d=$("#video-barrage-val").val();if(d!=""){var a=player.voddata;a.duration=player.time;a.text=d;a.yhuid=b;if(player.callback){player.callback({code:"barrage",post:a},function(c){if(c=="ok"){$("#video-barrage-val").val("")}else{if(c=="login"){if(player.full){player.exitFullscreen()}}}})}else{layer.msg("未接入回调")}}else{$("#video-barrage-val").focus()}});$("body").on("click",".video-barrage-off",function(){if($(this).hasClass("on")){$(this).removeClass("on");$("#canvasBarrage").hide()}else{$(this).addClass("on");$("#canvasBarrage").show()}});$(".video-barrage").bind("keyup",function(a){if(a.keyCode==13){$(".video-barrage-btn").click()}});window.onbeforeunload=function(e){player.socket.emit("logout",b)}},get_barrage_to:function(c){player.time=c;for(var d=0;d<player.barrage.length;d++){if(player.barrage[d].time<c&&!player.barrage[d].isadd){player.get_barrage_send(player.barrage[d]);player.barrage[d].isadd=true}}},get_barrage_send:function(p){var r=document.getElementById("canvasBarrage");var j;var m=0;var q;if(p.text!=""){j=document.createElement("span");j.innerHTML=p.text;j.className="barrage-span";if(p.url!=undefined){j.dataset.url=p.url}r.appendChild(j);j.style.top=n(parseInt(player.video.offsetHeight-j.offsetHeight))+"px";j.style.left=player.video.offsetWidth+"px";j.style.color=p.color;j.addEventListener("mouseover",l,false);j.addEventListener("mouseout",k,false);k()}function k(){m+=2;j.style.transform="translateX(-"+m+"px)";j.style.transition="transform 0s linear";if(m>=parseInt(player.video.offsetWidth+j.offsetWidth)){l();r.removeChild(j)}else{q=window.requestAnimationFrame(k)}}function l(){window.cancelAnimationFrame(q)}function o(a){return a.replace(/(^\s*)|(\s*$)/g,"")}function n(a){return parseInt(Math.random()*a)}},get_ads:function(c){var d=setInterval(function(){player.ads.time--;if(player.ads.time==0){$(".video-hls-ads").hide();clearInterval(d);player.load(c)}else{$(".video-hls-ads .adtime").html("广告倒计时 "+player.ads.time+" s")}},1000)},get_link:function(d){var c='<iframe src="'+d+"&nexturl="+player.nexturl+'" allowfullscreen="true" border="0" scrolling="no" frameborder="0" topmargin="0" style="width: 100%;height: 100%;position: absolute;background: #000;"></iframe>';$("#video-hls-box").html(c)},play:function(){if(player.duration==0){return}if(player.video.paused){$(".video-play-btn").css({opacity:1,width:"70px",height:"70px",marginTop:"-35px",marginLeft:"-35px"}).show();$(".video-play-btn").animate({opacity:0,width:"100px",height:"100px",marginTop:"-50px",marginLeft:"-50px"},500,function(){$(this).hide().css({opacity:1,width:"70px",height:"70px",marginTop:"-35px",marginLeft:"-35px"})});$(".video-hls-bottom .play").addClass("on");player.video.play();player.tindex=setTimeout(function(){player.get_cmd_hide()},3000)}else{$(".video-pause-btn").css({opacity:1,width:"70px",height:"70px",marginTop:"-35px",marginLeft:"-35px"}).show();$(".video-pause-btn").animate({opacity:0,width:"100px",height:"100px",marginTop:"-50px",marginLeft:"-50px"},500,function(){$(this).hide().css({opacity:1,width:"70px",height:"70px",marginTop:"-35px",marginLeft:"-35px"})});$(".video-hls-bottom .play").removeClass("on");player.video.pause()}},get_cmd_hide:function(){if(!player.cmd){$(".video-hls-cmd").animate({bottom:"-60px"},500)}},get_volume:function(k,g,i){var k=document.getElementById(k);var g=document.getElementById(g);var i=document.getElementById(i);var j=document,l=window,b=Math;k.onmousedown=function(d){var c=(d||l.event).clientY;var e=this.offsetTop;var a=i.offsetHeight-this.offsetHeight;j.onmousemove=function(f){var o=(f||l.event).clientY;var p=b.min(a,b.max(-2,e+(o-c)));var h=a-p+10;k.style.top=p+"px";g.style.height=h+"px";player.video.volume=(h/a).toFixed(1);l.getSelection?l.getSelection().removeAllRanges():j.selection.empty()};j.onmouseup=function(){this.onmousemove=null}}},get_duration:function(){var b=setInterval(function(){if(player.video){var a=/^\d+(?=\.{0,1}\d+$|$)/;if(a.test(player.video.duration)){player.duration=player.video.duration;$(".video-hls-bottom .time .duration").html(player.timetostr(player.video.duration));clearInterval(b)}}},500)},get_percent:function(){var d=$(".video-hls-slide").width(),c=$("#video-hls-box .video-tips");$(".video-hls-slide").mousemove(function(a){var b=a.offsetX;var e=parseInt(player.duration*b/d);c.html(player.timetostr(e)).css("left",b+"px").show()});$(".video-hls-slide").mouseout(function(){c.hide()});$(".video-hls-slide").bind("mousedown",function(a){var e=window.event||a;var b=e.offsetX;$(".video-hls-slide .percent").width(b);var h=parseInt(player.duration*b/d);player.video.currentTime=h;$(".video-hls-slide").bind("mousemove",function(f){var g=window.event||f;var k=g.offsetX;$(".video-hls-slide .percent").width(k);moveTimes=parseInt(player.duration*k/d);player.video.currentTime=moveTimes;console.log(moveTimes);setTimeout(function(){player.video.play()},500)});$(".video-hls-slide").mouseup(function(f){$(".video-hls-slide").unbind("mousemove")});$(".video-hls-slide").mouseleave(function(f){$(".video-hls-slide").unbind("mousemove")})})},timeupdate:function(j,i){var l=/^\d+(?=\.{0,1}\d+$|$)/;if(l.test(j)&&l.test(i)){if(!player.wap){if(j>0.5){$("#video-hls-box .load").hide()}for(var g=0;g<player.video.buffered.length;g++){if(player.video.buffered.start(player.video.buffered.length-1-g)<player.video.currentTime){var h=(player.video.buffered.end(player.video.buffered.length-1-g)/i)*100;$(".video-hls-slide .buffer").width(h+"%");break}}var k=j/i*100;$(".video-hls-bottom .time .currentTime").html(player.timetostr(j));$(".video-hls-slide .percent").css("width",k+"%");player.get_barrage_to(j)}if(player.pay.init>0&&player.pay.time>0&&j>player.pay.time){$(".pay-box").show();player.video.pause();player.video.src="";player.video.play();$(".video-hls-cmd,.video-box,.load").remove()}if(player.callback){if(player.currentTime==0||player.currentTime+60<j){player.currentTime=j;player.callback({code:"time",time:j})}}}},waiting:function(){$("#video-hls-box .load").show();var b=setInterval(function(){if($("#video-hls-box .load").css("display")=="none"){clearInterval(b);if(player.video.paused){player.video.play()}}},1000)},timetostr:function(h){var j="";if(h>-1){var g=Math.floor(h/3600);var f=Math.floor(h/60)%60;var i=(h%60).toFixed(0);if(g>0){if(g<10){j="0"+g+":"}else{j=g+":"}}if(f<10){j+="0"}j+=f+":";if(i<10){j+="0"}j+=i}return j},FullScreen:function(){player.full=true;var b=document.getElementById("video-hls-box");if(b.requestFullscreen){b.requestFullscreen()}else{if(b.mozRequestFullScreen){b.mozRequestFullScreen()}else{if(b.webkitRequestFullScreen){b.webkitRequestFullScreen()}}}},exitFullscreen:function(){player.full=false;var b=document;if(b.exitFullscreen){b.exitFullscreen()}else{if(b.mozCancelFullScreen){b.mozCancelFullScreen()}else{if(b.webkitCancelFullScreen){b.webkitCancelFullScreen()}}}},get_init_js:function(f){var d=document.createElement("script");d.type="text/javascript";d.src=f;var e=document.getElementsByTagName("head")[0];e.appendChild(d)}};player.get_init_js("/packs/admin/js/md5.js");player.get_init_js("/packs/player/hls.min.js");player.get_init_js("/packs/player/socket.io.js");